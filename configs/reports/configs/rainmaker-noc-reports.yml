---
ReportDefinitions:
  - reportName: UrbanCollectionReport
    summary: Collection Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: localisedmessage
        label: reports.noc.collectionreport.usagetype
        type: string
        source: rainmaker-noc
        total: false
      - name: transactionNumber
        label: reports.noc.collectionreport.transactionNumber
        type: string
        source: rainmaker-noc
        total: true
      - name: fees_counter
        label: reports.noc.collectionreport.fees_counter
        type: string
        source: rainmaker-noc
        total: true
      - name: fees_online
        label: reports.noc.collectionreport.fees_online
        type: string
        source: rainmaker-noc
        total: true
    searchParams:
      - name: fromDate
        label: reports.noc.collectionreport.fromDate
        type: epoch
        source: pt
        isMandatory: false
        searchClause: AND receiptdate >= $fromDate
      - name: toDate
        label: reports.noc.collectionreport.toDate
        type: epoch
        source: pt
        isMandatory: false
        searchClause: AND receiptdate <= $toDate
      - name: channel
        label: reports.noc.collectionreport.channel
        type: multivaluelist
        pattern: 'list://COUNTER:ULB Counter,ONLINE:Online by Citizen'
        source: common
        isMandatory: false
        searchClause: AND collectiontype IN ($channel)
      - name: paymentMode
        label: reports.noc.collectionreport.paymentMode
        type: singlevaluelist
        pattern: 'list://Cash:Cash,Online:Online,Card:Card,DD:DD,Cheque:Cheque'
        source: common
        isMandatory: false
        searchClause: AND instrumenttype = $paymentMode
      - name: ulb
        label: reports.noc.collectionreport.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fnoc.tenantId IN ($ulb)
    query: select COALESCE(message,usagetype) localisedmessage, COUNT(*) as transactionNumber, sum(case when collectiontype='COUNTER' then ins.amount else 0 end) fees_counter, sum(case when collectiontype='ONLINE' then ins.amount else 0 end) fees_online from eg_fn_firenoc fnoc inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid inner join egcl_receiptheader_v1 rhead on rhead.consumercode=fdet.applicationnumber inner join eg_fn_buidlings build on build.firenocdetailsuuid=fdet.uuid inner join egcl_receiptinstrument_v1 recins on recins.receiptheader=rhead.id inner join egcl_instrumentheader_v1 ins on recins.instrumentheader=ins.id left outer join message on code=concat('FIRENOC_BUILDINGTYPE_',UPPER(REGEXP_REPLACE(usagetype,'\..*',''))) and module='rainmaker-noc' where 1=1
    groupby: GROUP BY localisedmessage
    orderby: ORDER BY localisedmessage

  - reportName: UrbanApplicationStatusReport
    summary: Application Status Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: application_status
        label: reports.noc.applicationstatusreport.appStatus
        type: string
        source: rainmaker-noc
        total: false
      - name: number_of_application
        label: reports.noc.applicationstatusreport.noofapplications
        type: string
        source: rainmaker-noc
        total: true
    searchParams:
      - name: fromDate
        label: reports.noc.applicationstatusreport.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.applicationstatusreport.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: ulb
        label: reports.noc.applicationstatusreport.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fnoc.tenantId IN ($ulb)
    query: select COALESCE(message,state) application_status,count(*) number_of_application from eg_fn_firenoc fnoc inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid inner join (SELECT DISTINCT ON (businessid) * FROM eg_wf_processinstance_v2 ORDER BY businessid,createdtime desc) pinstance on pinstance.businessid=fdet.applicationnumber inner join eg_wf_state_v2 wfstate on pinstance.status=wfstate.uuid left outer join message on code=concat('WF_FIRENOC_',UPPER(state)) and module='rainmaker-noc'  where 1=1
    groupby: GROUP BY application_status
    orderby: ORDER BY application_status

  - reportName: UrbanChannelsReport
    summary: Channels Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: channel
        label: reports.noc.channelsreport.channel
        type: string
        source: rainmaker-noc
        total: false
      - name: number_of_applications
        label: reports.noc.channelsreport.applicationNo
        type: string
        source: rainmaker-noc
        total: true
      - name: percentage
        label: reports.noc.channelsreport.percentage
        type: string
        source: rainmaker-noc
        total: false
    searchParams:
      - name: fromDate
        label: reports.noc.channelsreport.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.channelsreport.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: ulb
        label: reports.noc.channelsreport.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fnoc.tenantId IN ($ulb)
    query: select channel, count (*) number_of_applications,round((count (*)::decimal/(select count(*) from eg_fn_firenoc fnoc inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid))*100,2) percentage from eg_fn_firenoc fnoc inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid
    groupby: GROUP BY channel
    orderby: ORDER BY channel


  - reportName: UrbanCollectionReport_V2
    summary: Collection Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: localisedmessage
        label: reports.noc.collectionreport.usagetype
        type: string
        source: rainmaker-noc
        total: false
      - name: transactionNumber
        label: reports.noc.collectionreport.transactionNumber
        type: string
        source: rainmaker-noc
        total: true
      - name: fees_counter
        label: reports.noc.collectionreport.fees_counter
        type: string
        source: rainmaker-noc
        total: true
      - name: fees_online
        label: reports.noc.collectionreport.fees_online
        type: string
        source: rainmaker-noc
        total: true
    searchParams:
      - name: fromDate
        label: reports.noc.collectionreport.fromDate
        type: epoch
        source: pt
        isMandatory: false
        searchClause: AND receiptdate >= $fromDate
      - name: toDate
        label: reports.noc.collectionreport.toDate
        type: epoch
        source: pt
        isMandatory: false
        searchClause: AND receiptdate <= $toDate
      - name: channel
        label: reports.noc.collectionreport.channel
        type: multivaluelist
        pattern: 'list://COUNTER:ULB Counter,ONLINE:Online by Citizen'
        source: common
        isMandatory: false
        searchClause: AND collectiontype IN ($channel)     
      - name: ulb
        label: reports.noc.collectionreport.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fnoc.tenantId IN ($ulb)
    query: | 
        Select 
          COALESCE(message,usagetype) localisedmessage,
          COUNT(*) as transactionNumber,
          --(select COALESCE((select message from message where code=concat('FIRENOC_FIRESTATIONS_',UPPER(REGEXP_REPLACE(firestationid,'\..*','')))  limit 1), firestationid)) as firestation,
          SUM (CASE WHEN egcl_payment.paymentmode='CASH' THEN egcl_payment.totalamountpaid ELSE 0 END) as fees_counter,
          SUM (CASE WHEN egcl_payment.paymentmode='ONLINE' THEN egcl_payment.totalamountpaid ELSE 0 END) AS fees_online
        from eg_fn_firenoc AS fnoc
        INNER JOIN eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid
        INNER JOIN egcl_bill as bill on bill.consumercode=fdet.applicationnumber
        INNER JOIN egcl_billdetial as billd on billd.billid=bill.id
        INNER JOIN  eg_fn_buidlings build on build.firenocdetailsuuid=fdet.uuid
        INNER JOIN egcl_paymentdetail ON (egcl_paymentdetail.billid=bill.id AND egcl_paymentdetail.businessservice='FIRENOC')
        INNER JOIN egcl_payment on egcl_payment.id=egcl_paymentdetail.paymentid
        LEFT OUTER JOIN message on code=concat('FIRENOC_BUILDINGTYPE_',UPPER(REGEXP_REPLACE(usagetype,'\..*','')))  
        INNER JOIN eg_fn_address as fad on fad.firenocdetailsuuid=fdet.uuid and module='rainmaker-noc' 
        where 1=1
        and egcl_payment.tenantid!='pb.testing' and fad.areatype='Urban' and egcl_payment.paymentstatus!='CANCELLED'
    groupby: GROUP BY (localisedmessage)
    orderby: ORDER BY localisedmessage

  - reportName: UrbanApplicationStatusReport_V2
    summary: Application Status Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: application_status
        label: reports.noc.applicationstatusreport.appStatus
        type: string
        source: rainmaker-noc
        total: false
      - name: number_of_application
        label: reports.noc.applicationstatusreport.noofapplications
        type: string
        source: rainmaker-noc
        total: true
    searchParams:
      - name: fromDate
        label: reports.noc.applicationstatusreport.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.applicationstatusreport.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: ulb
        label: reports.noc.applicationstatusreport.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fnoc.tenantid IN ($ulb)
    query: | 
      select 
        COALESCE(message,state) application_status,
        count(*) number_of_application 
      from eg_fn_firenoc fnoc 
      inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid 
      inner join (SELECT DISTINCT ON (businessid) * FROM eg_wf_processinstance_v2 ORDER BY businessid,createdtime desc) pinstance on pinstance.businessid=fdet.applicationnumber 
      inner join eg_wf_state_v2 wfstate on pinstance.status=wfstate.uuid 
      left outer join message on code=concat('WF_FIRENOC_',UPPER(state)) and module='rainmaker-noc'
      where 1=1 and fnoc.tenantid!='pb.testing'
    groupby: GROUP BY application_status
    orderby: ORDER BY application_status


  - reportName: UrbanChannelsReport_V2
    summary: Channels Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: channel
        label: reports.noc.channelsreport.channel
        type: string
        source: rainmaker-noc
        total: false
      - name: number_of_applications
        label: reports.noc.channelsreport.applicationNo
        type: string
        source: rainmaker-noc
        total: true
      - name: percentage
        label: reports.noc.channelsreport.percentage
        type: string
        source: rainmaker-noc
        total: false
    searchParams:
      - name: fromDate
        label: reports.noc.channelsreport.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.channelsreport.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: ulb
        label: reports.noc.channelsreport.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fnoc.tenantid IN ($ulb)
    query: |
        select 
          channel, 
          count (*) number_of_applications,
          round((count (*)::decimal/(select count(*) from eg_fn_firenoc fnoc inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid))*100,2) percentage 
        from eg_fn_firenoc fnoc 
        inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid
        where 1=1 and fnoc.tenantid!='pb.testing'
    groupby: GROUP BY channel
    orderby: ORDER BY channel 
    
  - reportName: RuralDistrictWiseCollectionReport_V2    
    summary: Rural District Wise Collection Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: subdistrict
        label: reports.noc.collectionreport.subdistrict
        type: string
        source: rainmaker-noc
        total: false
      - name: firestation
        label: reports.noc.collectionreport.firestation
        type: string
        source: rainmaker-noc
        total: false         
      - name: localisedmessage
        label: reports.noc.collectionreport.usagetype
        type: string
        source: rainmaker-noc
        total: false
      - name: transactionNumber
        label: reports.noc.collectionreport.transactionNumber
        type: string
        source: rainmaker-noc
        total: true
      - name: fees_counter
        label: reports.noc.collectionreport.fees_counter
        type: string
        source: rainmaker-noc
        total: true
      - name: fees_online
        label: reports.noc.collectionreport.fees_online
        type: string
        source: rainmaker-noc
        total: true
    searchParams:
      - name: fromDate
        label: reports.noc.collectionreport.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND receiptdate >= $fromDate
      - name: toDate
        label: reports.noc.collectionreport.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND receiptdate <= $toDate
      - name: channel
        label: reports.noc.collectionreport.channel
        type: multivaluelist
        pattern: 'list://COUNTER:ULB Counter,ONLINE:Online by Citizen'
        source: common
        isMandatory: false
        searchClause: AND collectiontype IN ($channel)
      - name: district
        label: reports.noc.collectionreport.district
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.city.districtTenantCode|$.MdmsRes.tenant.tenants.*.city.districtName
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fad.city IN ($district)      
    query: |
        Select 
          COALESCE(message,usagetype) localisedmessage,
          COUNT(*) as transactionNumber,
          fad.subdistrict,
          --(select COALESCE((select message from message where code=concat('FIRENOC_FIRESTATIONS_',UPPER(REGEXP_REPLACE(firestationid,'\..*','')))  limit 1), firestationid)) as firestation,
          SUM (CASE WHEN egcl_payment.paymentmode='CASH' THEN egcl_payment.totalamountpaid ELSE 0 END) as fees_counter,
          SUM (CASE WHEN egcl_payment.paymentmode='ONLINE' THEN egcl_payment.totalamountpaid ELSE 0 END) AS fees_online
        from eg_fn_firenoc AS fnoc
        INNER JOIN eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid
        INNER JOIN egcl_bill as bill on bill.consumercode=fdet.applicationnumber
        INNER JOIN egcl_billdetial as billd on billd.billid=bill.id
        INNER JOIN  eg_fn_buidlings build on build.firenocdetailsuuid=fdet.uuid
        INNER JOIN egcl_paymentdetail ON (egcl_paymentdetail.billid=bill.id AND egcl_paymentdetail.businessservice='FIRENOC')
        INNER JOIN egcl_payment on egcl_payment.id=egcl_paymentdetail.paymentid
        LEFT OUTER JOIN message on code=concat('FIRENOC_BUILDINGTYPE_',UPPER(REGEXP_REPLACE(usagetype,'\..*','')))  
        INNER JOIN eg_fn_address as fad on fad.firenocdetailsuuid=fdet.uuid and module='rainmaker-noc' 
        where 1=1  and egcl_payment.tenantid!='pb.testing' and fad.areatype='Rural' and egcl_payment.paymentstatus!='CANCELLED'
    groupby: GROUP BY (localisedmessage),fad.subdistrict
    orderby: ORDER BY localisedmessage

    
  - reportName: RuralDistrictWiseApplicationStatusReport_V2
    summary: Rural District Wise Application Status Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: subdistrict
        label: reports.noc.collectionreport.subdistrict
        type: string
        source: rainmaker-noc
        total: false 
      - name: firestation
        label: reports.noc.collectionreport.firestation
        type: string
        source: rainmaker-noc
        total: false            
      - name: application_status
        label: reports.noc.applicationstatusreport.appStatus
        type: string
        source: rainmaker-noc
        total: false
      - name: number_of_application
        label: reports.noc.applicationstatusreport.noofapplications
        type: string
        source: rainmaker-noc
        total: true
    searchParams:
      - name: fromDate
        label: reports.noc.applicationstatusreport.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.applicationstatusreport.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: district
        label: reports.noc.applicationstatusreport.district
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.city.districtTenantCode|$.MdmsRes.tenant.tenants.*.city.districtName
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fad.city IN ($district)  
    query: |
        select 
          fad.subdistrict as subdistrict,
          (select COALESCE((select message from message where code=concat('FIRENOC_FIRESTATIONS_',UPPER(REGEXP_REPLACE(firestationid,'\..*','')))  limit 1), firestationid)) as firestation,
          COALESCE(message,state) application_status,
          count(*) number_of_application 
        from eg_fn_firenoc fnoc 
        inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid 
        inner join (SELECT DISTINCT ON (businessid) * FROM eg_wf_processinstance_v2 ORDER BY businessid,createdtime desc) pinstance on pinstance.businessid=fdet.applicationnumber 
        inner join eg_wf_state_v2 wfstate on pinstance.status=wfstate.uuid left outer join message on code=concat('WF_FIRENOC_',UPPER(state)) and module='rainmaker-noc' 
        inner join eg_fn_address as fad on fad.firenocdetailsuuid=fdet.uuid 
        where 1=1  AND fad.subdistrict NOT LIKE 'pb.%'
    groupby: GROUP BY (application_status,subdistrict,firestation)
    orderby: ORDER BY application_status 
    
  - reportName: RuralDistrictWiseChannelsReport_V2
    summary: Rural District Wise Channels Report
    version: 1.0.0
    moduleName: rainmaker-noc
    sourceColumns:
      - name: subdistrict
        label: reports.noc.collectionreport.subdistrict
        type: string
        source: rainmaker-noc
        total: false
      - name: firestation
        label: reports.noc.collectionreport.firestation
        type: string
        source: rainmaker-noc
        total: false    
      - name: channel
        label: reports.noc.channelsreport.channel
        type: string
        source: rainmaker-noc
        total: false
      - name: number_of_applications
        label: reports.noc.channelsreport.applicationNo
        type: string
        source: rainmaker-noc
        total: true
      - name: percentage
        label: reports.noc.channelsreport.percentage
        type: string
        source: rainmaker-noc
        total: false
    searchParams:
      - name: fromDate
        label: reports.noc.channelsreport.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.channelsreport.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: district
        label: reports.noc.channelsreport.district
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.city.districtTenantCode|$.MdmsRes.tenant.tenants.*.city.districtName
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fad.city IN ($district)
    query: |
        select 
          channel,
          fad.subdistrict as subdistrict,
          (select COALESCE((select message from message where code=concat('FIRENOC_FIRESTATIONS_',UPPER(REGEXP_REPLACE(firestationid,'\..*','')))  limit 1), firestationid)) as firestation, 
          count (*) number_of_applications,
          round((count (*)::decimal/(select count(*) from eg_fn_firenoc fnoc inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid))*100,2) percentage 
        from eg_fn_firenoc fnoc 
        inner join eg_fn_firenocdetail fdet on fdet.firenocuuid=fnoc.uuid 
        inner join eg_fn_address as fad on fad.firenocdetailsuuid=fdet.uuid 
        Where 1=1 AND fad.subdistrict NOT LIKE 'pb.%'
    groupby: GROUP BY (channel,subdistrict,firestation)
    orderby: ORDER BY channel

  - reportName: ReceiptRegisterFirenocReport_V2
    decryptionPathId: ReceiptRegister_V2
    summary: Receipt Register FireNoc
    version: 1.0.0
    moduleName: rainmaker-noc
    additionalConfig:
      print:
        pdfPageSize: "A3"    
    sourceColumns:
      - name: ulb
        label: reports.noc.ulb
        type: string
        source: rainmaker-noc
        total: false
      - name: receiptnumber
        label: reports.noc.receiptnumber
        type: string
        source: rainmaker-noc
        total: false
      - name: applicationnumber
        label: reports.noc.applicationnumber
        type: string
        source: rainmaker-noc
        total: false         
      - name: receiptdate
        label: reports.noc.receiptdate
        type: string
        source: rainmaker-noc
        total: false
      - name: g8issuedate
        label: reports.noc.g8issuedate
        type: string
        source: rainmaker-noc
        total: false
      - name: g8receiptno
        label: reports.noc.g8receiptno
        type: string
        source: rainmaker-noc
        total: false
      - name: status
        label: reports.noc.status
        type: string
        source: rainmaker-noc
        total: false
      - name: servicecategory
        label: reports.noc.servicecategory
        type: string
        source: rainmaker-noc
        total: false
      - name: totalamount
        label: reports.noc.totalamount
        type: string
        source: rainmaker-noc
        total: true
      - name: paymentmode
        label: reports.noc.paymentmode
        type: string
        source: rainmaker-noc
        total: false
      - name: ddorchequenumber
        label: reports.noc.ddorchequenumber
        type: string
        source: rainmaker-noc
        total: false
      - name: firenoctype
        label: reports.noc.firenoctype
        type: string
        source: rainmaker-noc
        total: false
      - name: usagetype
        label: reports.noc.usagetype
        type: string
        source: rainmaker-noc
        total: false
      - name: areatype
        label: reports.noc.areatype
        type: string
        source: rainmaker-noc
        total: false
      - name: ownername
        label: reports.noc.ownername
        type: string
        source: rainmaker-noc
        total: false
      - name: collectiontype
        label: reports.noc.collectiontype
        type: string
        source: rainmaker-noc
        total: false
      - name: collectorname
        label: reports.noc.collectorname
        type: string
        source: rainmaker-noc
        total: false
    searchParams:
      - name: fromDate
        label: reports.noc.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: ulb
        label: reports.noc.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND payment.tenantid =$ulb
    query: |
        -- Use CTE to force query plan, compute & use CTE later
        WITH receipt_breakup AS (
                    SELECT 
                      egcl_billaccountdetail.billdetailid bill_id, 
                      string_agg(distinct consumercode,',') as consumercode                               
                    FROM egcl_billaccountdetail 
                    LEFT JOIN egcl_bill as bill on bill.id = egcl_billaccountdetail.billdetailid
                    WHERE  bill.tenantid!='pb.testing' AND businessservice='FIRENOC'
                    GROUP BY billdetailid
        )
        SELECT 
          payment.tenantid as ulb,
          paydetail.receiptnumber as receiptnumber,
          To_char((To_timestamp(paydetail.receiptdate / 1000) at time Zone 'Asia/Kolkata'), 'DD/MM/YYYY') as receiptdate,
          To_char((To_timestamp(paydetail.manualreceiptdate / 1000) at time Zone 'Asia/Kolkata'), 'DD/MM/YYYY') as g8issuedate,
          paydetail.manualreceiptnumber as g8receiptno,
          payment.paymentstatus as status,
          paydetail.businessservice as servicecategory,
          receipt_breakup.*,  
          payment.totalamountpaid as totalamount, 
          paymentmode as paymentmode,
          (case when paymentmode like 'CASH' then '' else  transactionnumber end) as ddorchequenumber,
          'System' as collectiontype,
          eg_user.name as collectorname,
          fdet.firenoctype as firenoctype,
          build.usagetype as usagetype,
          fad.areatype as areatype,
          fdet.applicationnumber as applicationnumber,
          build.name as ownername
        FROM egcl_payment AS payment
        LEFT JOIN egcl_paymentdetail as paydetail on paydetail.paymentid=payment.id
        LEFT JOIN receipt_breakup ON paydetail.billid = receipt_breakup.bill_id
        JOIN eg_user ON payment.createdby::INTEGER=eg_user.id
        JOIN egcl_bill as bill ON bill.id=paydetail.billid
        JOIN eg_fn_firenocdetail AS fdet ON fdet.applicationnumber=bill.consumercode
        JOIN eg_fn_buidlings AS build ON build.firenocdetailsuuid=fdet.uuid
        INNER JOIN eg_fn_address as fad on fad.firenocdetailsuuid=fdet.uuid
        WHERE  payment.tenantid!='pb.testing' AND paydetail.businessservice='FIRENOC' AND paydetail.receiptnumber NOT LIKE 'MP%' and payment.tenantid = $tenantid
        and payment.paymentstatus!='CANCELLED'
    orderby: ORDER BY paydetail.receiptdate DESC 

  - reportName: CancelledReceiptRegisterFirenocReport_V2
    decryptionPathId: ReceiptRegister_V2
    summary: Cancelled Receipt Register FireNoc
    version: 1.0.0
    moduleName: rainmaker-noc
    additionalConfig:
      print:
        pdfPageSize: "A3"    
    sourceColumns:
      - name: ulb
        label: reports.noc.ulb
        type: string
        source: rainmaker-noc
        total: false
      - name: receiptnumber
        label: reports.noc.receiptnumber
        type: string
        source: rainmaker-noc
        total: false
      - name: applicationnumber
        label: reports.noc.applicationnumber
        type: string
        source: rainmaker-noc
        total: false
      - name: receiptdate
        label: reports.noc.receiptdate
        type: string
        source: rainmaker-noc
        total: false
      - name: g8issuedate
        label: reports.noc.g8issuedate
        type: string
        source: rainmaker-noc
        total: false
      - name: g8receiptno
        label: reports.noc.g8receiptno
        type: string
        source: rainmaker-noc
        total: false
      - name: status
        label: reports.noc.status
        type: string
        source: rainmaker-noc
        total: false
      - name: servicecategory
        label: reports.noc.servicecategory
        type: string
        source: rainmaker-noc
        total: false
      - name: totalamount
        label: reports.noc.totalamount
        type: string
        source: rainmaker-noc
        total: true
      - name: paymentmode
        label: reports.noc.paymentmode
        type: string
        source: rainmaker-noc
        total: false
      - name: ddorchequenumber
        label: reports.noc.ddorchequenumber
        type: string
        source: rainmaker-noc
        total: false
      - name: collectiontype
        label: reports.noc.collectiontype
        type: string
        source: rainmaker-noc
        total: false
      - name: collectorname
        label: reports.noc.collectorname
        type: string
        source: rainmaker-noc
        total: false
    searchParams:
      - name: fromDate
        label: reports.noc.fromDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate >= $fromDate
      - name: toDate
        label: reports.noc.toDate
        type: epoch
        source: noc
        isMandatory: false
        searchClause: AND applicationdate <= $toDate
      - name: ulb
        label: reports.noc.ulb
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: noc
        wrapper: true
        isMandatory: false
        searchClause: AND fnoc.tenantId IN ($ulb)
    query: |
        -- Use CTE to force query plan, compute & use CTE later
        WITH receipt_breakup AS (
                    SELECT 
                      egcl_billaccountdetail.billdetailid bill_id, 
                      string_agg(distinct consumercode,',') as consumercode                               
                    FROM egcl_billaccountdetail 
                    LEFT JOIN egcl_bill as bill on bill.id = egcl_billaccountdetail.billdetailid
                    WHERE  bill.tenantid!='pb.testing' AND businessservice in ('FIRENOC')
                    GROUP BY billdetailid
        )
        SELECT 
          payment.tenantid as ulb,
          paydetail.receiptnumber as receiptnumber,
          To_char((To_timestamp(paydetail.receiptdate / 1000) at time Zone 'Asia/Kolkata'), 'DD/MM/YYYY') as receiptdate,
          To_char((To_timestamp(paydetail.manualreceiptdate / 1000) at time Zone 'Asia/Kolkata'), 'DD/MM/YYYY') as g8issuedate,
          paydetail.manualreceiptnumber as g8receiptno,
          payment.paymentstatus as status,
          paydetail.businessservice as servicecategory,
          receipt_breakup.*,  
          payment.totalamountpaid as totalamount, 
          paymentmode as paymentmode,
          (case when paymentmode like 'CASH' then '' else  transactionnumber end) as ddorchequenumber,
          'System' as collectiontype,
          eg_user.name as collectorname,
          fdet.firenoctype as firenoctype,
          build.usagetype as usagetype,
          fdet.applicationnumber as applicationnumber,
          build.name as ownername
        FROM egcl_payment AS payment
        LEFT JOIN egcl_paymentdetail as paydetail on paydetail.paymentid=payment.id
        LEFT JOIN receipt_breakup ON paydetail.billid = receipt_breakup.bill_id
        JOIN eg_user ON payment.createdby::INTEGER=eg_user.id
        JOIN egcl_bill as bill ON bill.id=paydetail.billid
        JOIN eg_fn_firenocdetail AS fdet ON fdet.applicationnumber=bill.consumercode
        JOIN eg_fn_buidlings AS build ON build.firenocdetailsuuid=fdet.uuid
        WHERE  payment.tenantid!='pb.testing' and paydetail.businessservice not in ('PT','TL','UC') and payment.paymentstatus = 'CANCELLED' and  paydetail.receiptnumber NOT LIKE 'MP%' 
        --and paydetail.tenantid=$tenantid
    orderby: ORDER BY paydetail.receiptdate DESC 

